name: JIT CI

on:
  push:
    branches: [ main, master ]
    paths:
      - 'src/**'
      - 'gc/**'
      - 'rc/**'
      - 'collections/**'
      - 'runtime/**'
      - 'Modules/**'
      - '.github/workflows/jit.yml'
  pull_request:
    branches: [ main, master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-linux-macos:
    name: Build (Unix) • ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential make gcc

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install make || true

      - name: Build Rubolt (Makefile in src)
        run: |
          make -C src -j

      - name: Show binary info
        run: |
          ls -lah src || true
          file src/rubolt || true

      - name: Archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: rubolt-${{ matrix.os }}
          path: |
            src/rubolt
            src/rubolt.exe
          if-no-files-found: ignore

  build-windows:
    name: Build (Windows) • MSYS2 MinGW64
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-make
          update: true

      - name: Build with mingw32-make
        shell: msys2 {0}
        run: |
          mingw32-make -C src -j

      - name: Fallback build_all.bat (if needed)
        if: ${{ always() }}
        shell: cmd
        run: |
          if not exist src\rubolt.exe (
            echo Fallback to build_all.bat
            call build_all.bat
          )

      - name: List build outputs
        shell: bash
        run: |
          ls -lah src || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rubolt-windows
          path: |
            src/rubolt.exe
          if-no-files-found: warn

  jit-smoke:
    name: JIT smoke tests
    needs: [ build-linux-macos, build-windows ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Build (ensure)
        run: |
          sudo apt-get update && sudo apt-get install -y build-essential make gcc
          make -C src -j

      - name: Verify JIT components compiled
        run: |
          test -f src/jit_compiler.o || echo "jit_compiler.o missing (object suffix varies by Make version)"
          grep -q "JIT" -n src/jit_compiler.c && echo "JIT source present"
          grep -q "Inline cache" -n src/inline_cache.c || true

      - name: Print JIT stats (dummy)
        run: |
          echo "JIT build complete; runtime smoke tests can be added once scripts are available."
